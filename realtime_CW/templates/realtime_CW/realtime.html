<!--
# Copyright 2014 University of Messina (UniMe)
#
# Author: Carmelo Romeo <caromeo@unime.it>
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

# -*- encoding: utf-8 -*-
#
# Author: Carmelo Romeo <caromeo@unime.it>
#
#
-->

{% load i18n %}
{% load url from future %}

<!-- Added inside folder /usr/lib/python2.6/site-packages/horizon/templatetags/ a python file (set_var.py) which contains the template for "set" command in template html style -->
{% load set_var %}

<script type="text/javascript">

	//Define the startsWith function to find a string at the beginning of another one
	if ( typeof String.prototype.startsWith != 'function' ) { 
		String.prototype.startsWith = function( str ) {
			return this.substring( 0, str.length ) === str;
		}
	};

	//Function to insert only numbers inside "samples_number" input
	function isNumberKey(evt){
		var charCode = (evt.which) ? evt.which : evt.keyCode
		if (charCode > 31 && (charCode < 48 || charCode > 57))
			return false;
		return true;
	}

	//GLOBAL VARIABLES
	//Extraction of name, title and resource_id of the metrics to be compared with the selected resource_id
	var name_list = [];
	var resourceid_list = [];
        {% for meter in vmmeters %}
                name_list.push("{{ meter.name }}");
                resourceid_list.push("{{ meter.resource_id }}");
        {% endfor %}

	//Extraction of VM name and resource_id from vms list (vms)
	var vm_name_list = [];
	var vm_id_list = [];
	{% for vm in vms %}
		vm_name_list.push("{{ vm.name }}");
		vm_id_list.push("{{ vm.id }}");
	{% endfor %}

	//Extraction of Heat stack id, name and related resources
	var stack_id_list = [];
	var stack_name_list = [];
	var stack_resources_list = [];

	{% for stack in stacks_info %}
		stack_id_list.push("{{ stack.stack_id }}");
		stack_name_list.push("{{ stack.stack_name }}");
		stack_resources_list.push("{{ stack.resources_number }}");

		{% for resource in stack.stack_resources %}
			stack_resources_list.push("{{ resource.stack_resource_id }}, {{ resource.stack_resource_name }}");
		{% endfor %}
	{% endfor %}

	//Entirely copy the stack_resources_list vector to a temporary one
	var temp_stack_resources_list = stack_resources_list.slice();
	var association_stackid_vms = [];

	for(s=0; s<stack_id_list.length; s++){
		for(i=0; i<temp_stack_resources_list.length; i++){
			//Check if the "i"-th element of the resources list vector represents the number of resources associated to the "j"-th stack_id. 
			//If YES we need to find the vm_id in order to retrieve the relative metrics list afterwards.
			if(/^\d+$/.test(temp_stack_resources_list[i])){
				var count =0;
				for(j=i+1; j<=i+temp_stack_resources_list[i] && j<temp_stack_resources_list.length; j++){
					var flag = "True";
					for(k=0; k<vm_id_list.length; k++){
						if(temp_stack_resources_list[j].split(',')[0] == vm_id_list[k]){
							if(flag == "True") {
								association_stackid_vms.push("STACKID:"+stack_id_list[s], vm_id_list[k], vm_name_list[k]); 
								flag = "False"; 
							}
							else    association_stackid_vms.push(vm_id_list[k], vm_name_list[k]);
						}
					}
					count++;
				}
				for(x=0;x<count+1;x++) temp_stack_resources_list.shift();
				break;
			}
		}
	}

	window.onload = function() {
		$("#stack_vms1").hide();
		$("#chartst1").hide();
		$("#chart_containerst1").hide();
	}

	function show_metrics_x_stackid(val){
		//We are considering "stacksXX" as val.id string from where we extract the line_number where to hide/show elements
		var line_number = val.id.substring(6,val.id.length);

		//Remove thread created inside 2f91d0180f32.js on form update
		$("#legendst"+line_number).hide();
		clearInterval($("#linechart_general_form"+line_number).data("thread"));
		$("#linechart_general_form"+line_number).data("thread",null);

		$(".meterst"+line_number).hide();

		$("#chart_containerst"+line_number).hide();
		document.getElementById('stack_vms'+line_number).innerHTML = "";


		if(val.value =="--"){

			$(".stackmetrics"+line_number).hide();
			document.getElementById('metrics_x_stack'+line_number).innerHTML = "";
		}
		else{
			$("#buttonst"+line_number).hide();

			var new_vm_id_list = [];
			var new_vm_name_list = [];
			var vm_element = document.getElementById("metrics_x_stack"+line_number);

			//Necessary to concatenate line_number inside innerHTML
			{% set line_number  = ""+line_number+"" %}

			var string_pre =" \
				<div class='form-group'> \
					<label for='meter' class='stackmetrics{{ line_number }} control-label col-sm-2'>{% trans 'Metrics' %}:&nbsp;</label> \
					  <div class='controls line_chart_time_picker'> \
						<select name='stack_metrics' id='stackmetrics{{ line_number }}' class='form-control stackmetrics{{ line_number }}' value='stackmetrics{{ line_number }}' onchange='show_stack_vms_from_metric(this);' style='width: auto'>";

			var string_vms ="";

			string_vms += " \
				  <optgroup label='{% trans "Shared Metrics" %}'>";

			var string_post = "</optgroup> \
					   </select> \
					 </div> \
				 </div>";

			vm_element.innerHTML = string_pre+" "+string_vms+" "+string_post;

			$('#stackmetrics'+line_number).append('<option title="--" value="--">--</option>');

			var selects = document.getElementById("stacks{{ line_number }}");

			for(i=0; i<association_stackid_vms.length; i++){
				if(association_stackid_vms[i].split('STACKID:')[1] == selects.options[selects.selectedIndex].value){
					new_vm_id_list.push(association_stackid_vms[i+1]);
					new_vm_name_list.push(association_stackid_vms[i+2]);
					//alert(association_stackid_vms[i+1]+" "+association_stackid_vms[i+2]);
				}
			}

			//Section related to the list of all the metrics related to the vms deployed in the selected stack_id
			var shared_metrics_list =[];
			var summary = "";
			var insert = "False";
			for(i=0; i<resourceid_list.length; i++){
				for(v=0; v<new_vm_id_list.length; v++){
					if(resourceid_list[i]==new_vm_id_list[v]){
						if(shared_metrics_list.length ==0){
							shared_metrics_list.push(name_list[i]);
							summary=name_list[i];
						}
						else{
							for(s=0; s<shared_metrics_list.length; s++){
								if(shared_metrics_list[s]!=name_list[i]) insert = "True";
								else{
									insert = "False";
									break;
								}
							}
							if(insert == "True"){
								shared_metrics_list.push(name_list[i]);
								summary=summary+";"+name_list[i];
							}
						}
					}
				}
			}
			//alert(summary);

			for(j=0; j<shared_metrics_list.length; j++){
					$('#stackmetrics'+line_number).append('<option title="'+shared_metrics_list[j]+'" value="'+shared_metrics_list[j]+'" data-unit="">'+shared_metrics_list[j]+'</option>');
			}
		}
	}


	function show_stack_vms_from_metric(val) {
		//We are considering "stackmetricsXX" as val.id string from where we extract the line_number where to hide/show elements
		var line_number = val.id.substring(12,val.id.length);
		//alert('val.id: '+val.id+ ' val.value: '+val.value+ ' line: '+line_number);

                //Remove thread created inside 2f91d0180f32.js on form update
                $("#legendst"+line_number).hide();
                clearInterval($("#linechart_general_form"+line_number).data("thread"));
                $("#linechart_general_form"+line_number).data("thread",null);

                $("#chart_containerst"+line_number).hide();
                document.getElementById('stack_vms'+line_number).innerHTML = "";

		if(val.value =="--"){
			$("#stack_vms"+line_number).hide();
			$(".meterst"+line_number).hide();
			$("#chartst"+line_number).hide();
		}
		else{
			$("#stack_vms"+line_number).show();
			$(".meterst"+line_number).show();
                        //$("#chartst"+line_number).show();

			var metric_element = document.getElementById("stack_vms"+line_number);

			//Necessary to concatenate line_number inside innerHTML
			{% set line_numberstack  = ""+line_number+"" %}

                        var string_pre =" \
				<div class='form-group'> \
				    <label class='control-label col-sm-2'>{% trans 'Samples Num' %}:&nbsp;</label> \
	                             <input name='samples_number' type='text' id='samples_number{{ line_numberstack }}' class='form-control' style='width:50px' value='100' maxlength='3' size='3' onKeyPress='return isNumberKey(event)'/> \
				     <input name='th_start_time' type='hidden' id='thread_start_time{{ line_numberstack }}' value='' /> \
				     <input name='offset_time' type='hidden' id='offset_time{{ line_numberstack }}' value='' /> \
				     <input name='vms_selected_list' type='hidden' id='vms_selected_list{{ line_numberstack }}' value='' /> \
				     <input name='renderer' type='hidden' id='renderer{{ line_numberstack }}' value='line' /> \
				</div> \
				<div class='form-group'> \
				    <label class='control-label col-sm-2'>{% trans 'Interval(ms)' %}:&nbsp;</label> \
				    <input name='interval' type='text' id='interval{{ line_numberstack }}' class='form-control interval' style='width:65px' value='5000' maxlength='6' size='6' onKeyPress='return isNumberKey(event)'/> \
				</div> \
                                <div class='form-group'> \
                                  <label for='meter' class='meterst{{ line_numberstack }} control-label col-sm-2'>{% trans 'VMs' %}:&nbsp;</label> \
                                  <div class='controls line_chart_time_picker'> \
                                        <select data-line-chart-command='select_box_realtime_change' multiple='multiple' style='width: auto' name='meter' id='meterst{{ line_numberstack }}' class='form-control meterst{{ line_numberstack }}' value='meterst{{ line_numberstack }}' onchange= set_th_start_time(this)> \
                                          <optgroup label='{% trans "Virtual Machines" %}'>";


			var string_measures;
			
			var new_vm_id_list = [];
			var new_vm_name_list = [];
			var selects = document.getElementById("stacks{{ line_numberstack }}");

			for(i=0; i<association_stackid_vms.length; i++){
				if(association_stackid_vms[i].split('STACKID:')[1] == selects.options[selects.selectedIndex].value){
					new_vm_id_list.push(association_stackid_vms[i+1]);
					new_vm_name_list.push(association_stackid_vms[i+2]);
					//alert(association_stackid_vms[i+1]+" "+association_stackid_vms[i+2]);
				}
			}


			for (i=0; i<name_list.length; i++){
				//If clauses to list only those metrics related to the selected (val.value) instance [resource_id]
				if(name_list[i] == val.value){
					for(j=0; j<new_vm_id_list.length; j++){
						if(new_vm_id_list[j] == resourceid_list[i]){
							var concat_name_resourceid = name_list[i]+';'+new_vm_id_list[j];
							string_measures +="<option title="+new_vm_name_list[j]+" value="+concat_name_resourceid+" data-unit=''>"+new_vm_name_list[j]+" </option>";
						}
					}
				}
			}


                        var string_post = "</optgroup> \
                                        </select> \
                                  </div> \
                                </div> \
                        <button class='btn btn-default btn-sm' type='button' style='vertical-align:top;' id='buttonst{{ line_numberstack }}' data-line-chart-command='button_realtime_plot' value=0 onclick='change_button(this);'>Plot</button> ";
			metric_element.innerHTML = string_pre+" "+string_measures+" "+string_post;
		}
	}

	//Change Plot button style
	function change_button(val){

		var SelectedOptions = document.getElementById("meterst"+val.id.substring(8,val.id.length));

		if(SelectedOptions.value != ''){
		  if(val.value ==0){
			document.getElementById(val.id).value =1;

			document.getElementById(val.id).style.color='#fff';
			document.getElementById(val.id).style.backgroundColor='#d9534f';
			document.getElementById(val.id).style.borderColor='#d43f3a';
			document.getElementById(val.id).innerHTML="Stop";
		  }
		  else{
			document.getElementById(val.id).value =0;

                        document.getElementById(val.id).style.color='#333';
                        document.getElementById(val.id).style.backgroundColor='#fff';
                        document.getElementById(val.id).style.borderColor='#ccc';
			document.getElementById(val.id).innerHTML="Plot";
		  }
		}
	}

	//Function to set thread_start_time
	function set_th_start_time(val){

                //FIX date offset from UTC
		//----------------------------------------------------------------------------------
		var data = new Date();
		/*
		var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
		//var localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0,-1);
		var data = (new Date(Date.now() - tzoffset));

                alert('ISOString: '+data.toISOString());
		*/
		//alert(-data.getTimezoneOffset());
		document.getElementById('offset_time'+val.id.substring(7,val.id.length)).value = -data.getTimezoneOffset();
		//----------------------------------------------------------------------------------

		//It works with set and get Seconds but at the moment we don't need to use them because we start retrieving samples as soon as (thread_start_time) the selecion of VMs to plot is made
		//data.setSeconds(data.getSeconds()-50);
		document.getElementById('thread_start_time'+val.id.substring(7,val.id.length)).value = data.toISOString();

		//Function to populate the vm_selected_list input.value
                var SelectedOptions = document.getElementById("meter"+val.id.substring(5,val.id.length));
                var list='';
                
                //creo una stringa concatenata con i resourceId (e altri campi divisi dal ';') delle linee selezionate divise tra loro dal '&'
                for (var i=0;i<SelectedOptions.length;i++) {
                        if (SelectedOptions.options[i].selected) {
                                list += list == '' ? SelectedOptions.options[i].value + ";" + SelectedOptions.options[i].text : "&"+SelectedOptions.options[i].value + ";" + SelectedOptions.options[i].text;
                        }
                }
               	document.getElementById('vms_selected_list'+val.id.substring(7,val.id.length)).value = list;

                if(list == ''){
                        alert("You should choose at least one (or more) Virtual Machine(s) !");
			document.getElementById('interval'+val.id.substring(7,val.id.length)).readOnly = false;
                        return;
                }
		else 
			document.getElementById('interval'+val.id.substring(7,val.id.length)).readOnly = true;
	}


	//Add/remove metrics from stack application START
	function removemetricst(val){
			
		if ($("#buttonst"+val.value).data("container") != null){
	                clearInterval($("#buttonst"+val.value).data("container").thread);
		}
		document.getElementById('new_metric_linest'+val.value).remove();
	}

	function addmetricst(val){

		var next_num = parseInt(val.value)+1;
		document.getElementById('afterst'+val.value).style.display = 'none';

		document.getElementById("new_metricst"+val.value).innerHTML=(" \
		{% set next_metric  = ""+next_num+"" %} \
		<div id='new_metric_linest{{ next_metric }}'> \
			<form class='form-horizontal' \
			id='linechart_general_form{{ next_metric }}' > \
				<div class='form-group'> \
				<label for='stacks' class='control-label col-sm-2'>{% trans "Stack_id" %}:&nbsp;</label> \
					<div class='col-sm-2'> \
					  <select name='stacks' id='stacks{{ next_metric }}' class='form-control' onchange='show_metrics_x_stackid(this);' style='width: auto'> \
					  <optgroup label='{% trans "Stacks" %}'> \
						<option title='--' value='--'>--</option> \
							{% for stack in stacks_info %} \
						<option title='{{ stack.stack_name }}' value='{{ stack.stack_id }}' data-unit=''> \
							{{ stack.stack_name }} \
						</option> \
							{% endfor %} \
					  </optgroup> \
		 			  </select> \
			     	         </div> \
				</div> \
				<p id='metrics_x_stack{{ next_metric }}'></p> \
				<p id='stack_vms{{ next_metric }}'></p> \
		        </form> \
		        <table> \
			  <tr> \
	   			<td><button class='btn btn-small' type='submit' style='vertical-align:top;' value='{{ next_metric }}' onclick='removemetricst(this);'>Remove Metric</button></td> \
			  </tr> \
		        </table> \
			<div class='info row detail'> \
			<div id='chart_containerst{{ next_metric }}' class='col-sm-9 chart_container' style='display:inline-block;width:75%;'> \
                                <div id='chartst{{ next_metric }}' class='chart' \
					data-chart-type='line_chart' \
					data-url='{% url "horizon:admin:realtime_CW:samples"%}' \
					data-form-selector='#linechart_general_form{{ next_metric }}' \
                                        data-legend-selector='#legendst{{ next_metric }}' \
                                        data-smoother-selector='#smootherst{{ next_metric }}' \
                                        data-slider-selector='#sliderst{{ next_metric }}'> \
                                </div> \
				<div id='sliderst{{ next_metric }}'></div> \
			</div> \
		        <div id='legendst{{ next_metric }}' style='display:inline-block;width:20%;'></div> \
                        </div> \
		</div> \
	        <div id='afterst{{ next_metric }}'> \
			&nbsp;&nbsp; \
			<table> \
			  <tr> \
			   <td><button class='btn btn-small' type='submit' style='vertical-align:top;' value='{{ next_metric }}' onclick='addmetricst(this);'>Add Metric</button></td> \
			  </tr> \
			</table> \
	        </div> \
		<!-- This is the section inside which new metric lines will be added and removed from --> \
	        <div id='new_metricst{{ next_metric }}'></div> \
			")

		//START - Onload of the new metric section
                $("#stack_vms"+next_num).hide();
                $("#chartst"+next_num).hide();
                $("#chart_containerst"+next_num).hide();
		//STOP - Onload of the new metric section


	}
	//Add/remove metrics from stack application END

</script>



<h4>{% trans "Select Metric from Stack Application" %}</h4>
<div id="ceilometer-stats">

   <form class="form-horizontal" id="linechart_general_form1">
    <div class="form-group">
      <label for="stacks" class="control-label col-sm-2">{% trans "Stack_id" %}:&nbsp;</label>
      <div class="col-sm-2">
        <select name="stacks" id="stacks1" class="form-control" onchange="show_metrics_x_stackid(this);" style="width: auto">
          <optgroup label='{% trans "Stacks" %}'>
            <option title="--" value="--">--</option>
            {% for stack in stacks_info %}
            <option title="{{ stack.stack_name }}" value="{{ stack.stack_id }}" data-unit="">
            {{ stack.stack_name }}
            </option>
            {% endfor %}
          </optgroup>
        </select>
      </div>
    </div>
    <p id="metrics_x_stack1"></p>
    <p id="stack_vms1"></p>
  </form>


<div class="info row detail">

  <div id="chart_containerst1" class="col-sm-9 chart_container" style="display:inline-block;width:75%;">
        <div id="chartst1" class="chart"
		data-chart-type="line_chart"
		data-url="{% url 'horizon:admin:realtime_CW:samples'%}"
		data-form-selector="#linechart_general_form1"
                data-legend-selector="#legendst1"
                data-smoother-selector="#smootherst1"
                data-slider-selector="#sliderst1">
        </div>
        <div id="sliderst1"></div>
  </div>

  &nbsp;&nbsp;
  <div id="legendst1" style="display:inline-block;width:20%;"></div>

</div> <!-- CLOSE "info row detail" -->

  <div id="afterst1">
        &nbsp;&nbsp;
        <table>
          <tr>
           <td><button class="btn btn-default btn-sm" type="submit" style="vertical-align:top;" value="1" onclick="addmetricst(this);">Add Metric</button></td>
          </tr>
        </table>
  </div>
  <!-- This is the section inside which new metric lines will be added and removed from -->
  <div id="new_metricst1"></div>

</div> <!-- CLOSE ceilometer-stats -->

